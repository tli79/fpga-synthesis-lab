library IEEE;
use IEEE.std_logic_1164.all;
use IEEE.numeric_std.all;
library UNISIM;
use UNISIM.vcomponents.all;

entity lab_g is
    port(
        clk:   in  std_logic;
        right: out std_logic;
        left:  out std_logic
    );
end lab_g;

architecture arch of lab_g is
    signal addr_r:      unsigned(10 downto 0);-- 2048 samples
    signal addr_l:      unsigned(10 downto 0);-- 2048 samples
    signal addr_r_next: unsigned(10 downto 0);
    signal addr_l_next: unsigned(10 downto 0);
    signal data_r:      unsigned(17 downto 0);-- 18 bit data
    signal data_l:      unsigned(17 downto 0);-- 18 bit data
    signal bram_addr_r: std_logic_vector(15 downto 0);
    signal bram_addr_l: std_logic_vector(15 downto 0);
    signal bram_data_r: std_logic_vector(35 downto 0);
    signal bram_data_l: std_logic_vector(35 downto 0);
    signal vout_r:      unsigned(17 downto 0);
    signal vout_l:      unsigned(17 downto 0);
    signal vin_r:       unsigned(17 downto 0);
    signal vin_l:       unsigned(17 downto 0);
    signal vin_r_prev:  unsigned(17 downto 0);
    signal vin_l_prev:  unsigned(17 downto 0);
    signal carry:       std_logic;

begin

--    process(clk,addr_r)
--    begin
--        if rising_edge(clk) then
--            if (addr_r = 4) then
--                addr_r <= 0;
--            else
--                addr_r <= addr_r + 1;
--            end if;
--        end if;

--        if rising_edge(clk) then
--            if (carry=1) then
--                if (count1=4) then
--                    count1<=0;
--                else
--                    count1<=count1+1;
--                end if;
--            end if;
--        end if;
--    end process;

    process(addr_r, addr_l)
    begin
        --Addr_r counter
        if (addr_r = b"111_1111_1111") then
            addr_r_next <= b"000_0000_0000";
        else
            addr_r_next <= addr_r + 1;
        end if;

        --Right model
        vout_r <= vout_r - shift_right(vout_r, 7) + shift_right(vin_r_prev, 7);
        --Compare loop
        if (vout_r >= data_r) then
            vin_r <= b"00_0000_0000_0000_0000";
            right <= '0';
        elsif (vout_r < data_r) then
            vin_r <= b"11_1111_1111_1111_1111";
            right <= '1';
        end if;
        --Update old vin_r
        vin_r_prev <= vin_r;
    end process;

    process(clk)
    begin
        if rising_edge(clk) then
            addr_r<=addr_r_next ;
        end if;
    end process;

    -- Block RAM instantiation and bit mapping
    bram_addr_r<='1'&std_logic_vector(addr_r)&b"0000";
    bram_addr_l<='1'&std_logic_vector(addr_l)&b"0000";
    data_r<=unsigned(bram_data_r(33 downto 32)&bram_data_r(15 downto 0));
    data_l<=unsigned(bram_data_l(33 downto 32)&bram_data_l(15 downto 0));
    bram: RAMB36E1 generic map (
            READ_WIDTH_A=>18,
            READ_WIDTH_B=>18,
            INITP_00=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_01=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_02=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_03=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_04=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_05=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_06=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_07=>X"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",
            INITP_08=>X"5555555555555555555555555555555555555555555555555555555555555556",
            INITP_09=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INITP_0A=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INITP_0B=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INITP_0C=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INITP_0D=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INITP_0E=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INITP_0F=>X"5555555555555555555555555555555555555555555555555555555555555555",
            INIT_00=>X"075C06DE066105E3056604E8046A03ED036F02F1027401F6017800FB007D0000",
            INIT_01=>X"0F310EB40E370DBA0D3D0CBF0C420BC50B470ACA0A4D09CF095208D4085707D9",
            INIT_02=>X"16FD168116041588150B148F141213951319129C121F11A2112510A8102B0FAE",
            INIT_03=>X"1EBB1E401DC41D491CCD1C521BD61B5A1ADE1A6219E6196A18EE187217F6177A",
            INIT_04=>X"266625EC257224F8247D24032388230E22932218219E212320A8202D1FB21F36",
            INIT_05=>X"2DF92D812D082C902C172B9E2B252AAC2A3329BA294028C7284D27D4275A26E0",
            INIT_06=>X"357034FA3483340C3395331E32A7323031B8314130C930522FDA2F622EEA2E72",
            INIT_07=>X"3CC63C523BDD3B693AF43A7F3A0A3995391F38AA383437BF374936D3365D35E6",
            INIT_08=>X"43F64385431342A0422E41BC414940D640633FF03F7D3F093E963E223DAE3D3A",
            INIT_09=>X"4AFD4A8E4A1F49AF493F48D0486047F0477F470F469E462D45BC454B44DA4468",
            INIT_0A=>X"51D5516950FD509050244FB74F4A4EDD4E6F4E014D944D264CB74C494BDB4B6C",
            INIT_0B=>X"587B581257A9574056D6566D56035599552F54C4545953EF5384531852AD5241",
            INIT_0C=>X"5EEA5E855E1F5DBA5D545CEE5C875C215BBA5B535AEB5A845A1C59B4594C58E4",
            INIT_0D=>X"651F64BD645C63FA6397633562D2626F620C61A9614560E1607D60195FB45F4F",
            INIT_0E=>X"6B156AB86A5A69FC699E693F68E06881682267C36763670366A2664265E16580",
            INIT_0F=>X"70C9707070176FBD6F636F086EAE6E536DF86D9C6D416CE56C896C2C6BCF6B72",
            INIT_10=>X"763875E3758E753974E3748D743773E1738A733372DB7284722C71D4717B7122",
            INIT_11=>X"7B5E7B0E7ABD7A6D7A1C79CA7979792778D47882782F77DC7789773576E1768D",
            INIT_12=>X"80387FEC7FA17F557F097EBC7E6F7E227DD57D877D397CEA7C9C7C4D7BFD7BAE",
            INIT_13=>X"84C2847C843583EF83A78360831882D08287823E81F581AC8162811880CD8083",
            INIT_14=>X"88FB88BA8879883787F587B28770872D86E986A58661861D85D88593854E8508",
            INIT_15=>X"8CDF8CA48C688C2B8BEE8BB18B748B368AF88ABA8A7B8A3C89FC89BC897C893C",
            INIT_16=>X"906D903790008FC98F928F5A8F228EEA8EB18E788E3F8E058DCB8D918D568D1B",
            INIT_17=>X"93A193719340930E92DD92AB92789245921291DF91AB91779142910E90D890A3",
            INIT_18=>X"967A9650962495F995CD95A095749547951994EC94BD948F94609431940193D1",
            INIT_19=>X"98F798D298AD98879861983A981397EC97C4979C9774974B972296F996CF96A5",
            INIT_1A=>X"9B159AF69AD79AB79A969A769A559A349A1299F099CD99AB998799649940991C",
            INIT_1B=>X"9CD49CBB9CA19C879C6D9C529C379C1C9C009BE49BC89BAB9B8E9B709B529B34",
            INIT_1C=>X"9E319E1E9E0B9DF79DE39DCF9DBA9DA49D8F9D799D629D4B9D349D1D9D059CEC",
            INIT_1D=>X"9F2E9F219F139F069EF89EE99EDA9ECB9EBC9EAC9E9B9E8B9E7A9E689E569E44",
            INIT_1E=>X"9FC89FC19FBA9FB29FAA9FA29F999F909F879F7D9F739F689F5D9F529F469F3A",
            INIT_1F=>X"9FFF9FFF9FFE9FFC9FFB9FF89FF69FF39FF09FEC9FE89FE49FDF9FDA9FD49FCE",
            INIT_20=>X"9FD49FDA9FDF9FE49FE89FEC9FF09FF39FF69FF89FFB9FFC9FFE9FFF9FFF9FFF",
            INIT_21=>X"9F469F529F5D9F689F739F7D9F879F909F999FA29FAA9FB29FBA9FC19FC89FCE",
            INIT_22=>X"9E569E689E7A9E8B9E9B9EAC9EBC9ECB9EDA9EE99EF89F069F139F219F2E9F3A",
            INIT_23=>X"9D059D1D9D349D4B9D629D799D8F9DA49DBA9DCF9DE39DF79E0B9E1E9E319E44",
            INIT_24=>X"9B529B709B8E9BAB9BC89BE49C009C1C9C379C529C6D9C879CA19CBB9CD49CEC",
            INIT_25=>X"99409964998799AB99CD99F09A129A349A559A769A969AB79AD79AF69B159B34",
            INIT_26=>X"96CF96F99722974B9774979C97C497EC9813983A9861988798AD98D298F7991C",
            INIT_27=>X"940194319460948F94BD94EC95199547957495A095CD95F996249650967A96A5",
            INIT_28=>X"90D8910E9142917791AB91DF92129245927892AB92DD930E9340937193A193D1",
            INIT_29=>X"8D568D918DCB8E058E3F8E788EB18EEA8F228F5A8F928FC990009037906D90A3",
            INIT_2A=>X"897C89BC89FC8A3C8A7B8ABA8AF88B368B748BB18BEE8C2B8C688CA48CDF8D1B",
            INIT_2B=>X"854E859385D8861D866186A586E9872D877087B287F58837887988BA88FB893C",
            INIT_2C=>X"80CD8118816281AC81F5823E828782D08318836083A783EF8435847C84C28508",
            INIT_2D=>X"7BFD7C4D7C9C7CEA7D397D877DD57E227E6F7EBC7F097F557FA17FEC80388083",
            INIT_2E=>X"76E17735778977DC782F788278D47927797979CA7A1C7A6D7ABD7B0E7B5E7BAE",
            INIT_2F=>X"717B71D4722C728472DB7333738A73E17437748D74E37539758E75E37638768D",
            INIT_30=>X"6BCF6C2C6C896CE56D416D9C6DF86E536EAE6F086F636FBD7017707070C97122",
            INIT_31=>X"65E1664266A26703676367C36822688168E0693F699E69FC6A5A6AB86B156B72",
            INIT_32=>X"5FB46019607D60E1614561A9620C626F62D26335639763FA645C64BD651F6580",
            INIT_33=>X"594C59B45A1C5A845AEB5B535BBA5C215C875CEE5D545DBA5E1F5E855EEA5F4F",
            INIT_34=>X"52AD5318538453EF545954C4552F55995603566D56D6574057A95812587B58E4",
            INIT_35=>X"4BDB4C494CB74D264D944E014E6F4EDD4F4A4FB75024509050FD516951D55241",
            INIT_36=>X"44DA454B45BC462D469E470F477F47F0486048D0493F49AF4A1F4A8E4AFD4B6C",
            INIT_37=>X"3DAE3E223E963F093F7D3FF0406340D6414941BC422E42A04313438543F64468",
            INIT_38=>X"365D36D3374937BF383438AA391F39953A0A3A7F3AF43B693BDD3C523CC63D3A",
            INIT_39=>X"2EEA2F622FDA305230C9314131B8323032A7331E3395340C348334FA357035E6",
            INIT_3A=>X"275A27D4284D28C7294029BA2A332AAC2B252B9E2C172C902D082D812DF92E72",
            INIT_3B=>X"1FB2202D20A82123219E22182293230E23882403247D24F8257225EC266626E0",
            INIT_3C=>X"17F6187218EE196A19E61A621ADE1B5A1BD61C521CCD1D491DC41E401EBB1F36",
            INIT_3D=>X"102B10A8112511A2121F129C131913951412148F150B15881604168116FD177A",
            INIT_3E=>X"085708D4095209CF0A4D0ACA0B470BC50C420CBF0D3D0DBA0E370EB40F310FAE",
            INIT_3F=>X"007D00FB017801F6027402F1036F03ED046A04E8056605E3066106DE075C07D9",
            INIT_40=>X"F8A3F921F99EFA1CFA99FB17FB95FC12FC90FD0EFD8BFE09FE87FF04FF820000",
            INIT_41=>X"F0CEF14BF1C8F245F2C2F340F3BDF43AF4B8F535F5B2F630F6ADF72BF7A8F826",
            INIT_42=>X"E902E97EE9FBEA77EAF4EB70EBEDEC6AECE6ED63EDE0EE5DEEDAEF57EFD4F051",
            INIT_43=>X"E144E1BFE23BE2B6E332E3ADE429E4A5E521E59DE619E695E711E78DE809E885",
            INIT_44=>X"D999DA13DA8DDB07DB82DBFCDC77DCF1DD6CDDE7DE61DEDCDF57DFD2E04DE0C9",
            INIT_45=>X"D206D27ED2F7D36FD3E8D461D4DAD553D5CCD645D6BFD738D7B2D82BD8A5D91F",
            INIT_46=>X"CA8FCB05CB7CCBF3CC6ACCE1CD58CDCFCE47CEBECF36CFADD025D09DD115D18D",
            INIT_47=>X"C339C3ADC422C496C50BC580C5F5C66AC6E0C755C7CBC840C8B6C92CC9A2CA19",
            INIT_48=>X"BC09BC7ABCECBD5FBDD1BE43BEB6BF29BF9CC00FC082C0F6C169C1DDC251C2C5",
            INIT_49=>X"B502B571B5E0B650B6C0B72FB79FB80FB880B8F0B961B9D2BA43BAB4BB25BB97",
            INIT_4A=>X"AE2AAE96AF02AF6FAFDBB048B0B5B122B190B1FEB26BB2D9B348B3B6B424B493",
            INIT_4B=>X"A784A7EDA856A8BFA929A992A9FCAA66AAD0AB3BABA6AC10AC7BACE7AD52ADBE",
            INIT_4C=>X"A115A17AA1E0A245A2ABA311A378A3DEA445A4ACA514A57BA5E3A64BA6B3A71B",
            INIT_4D=>X"9AE09B429BA39C059C689CCA9D2D9D909DF39E569EBA9F1E9F829FE6A04BA0B0",
            INIT_4E=>X"94EA954795A59603966196C0971F977E97DD983C989C98FC995D99BD9A1E9A7F",
            INIT_4F=>X"8F368F8F8FE89042909C90F7915191AC9207926392BE931A937693D39430948D",
            INIT_50=>X"89C78A1C8A718AC68B1C8B728BC88C1E8C758CCC8D248D7B8DD38E2B8E848EDD",
            INIT_51=>X"84A184F18542859285E38635868686D8872B877D87D08823887688CA891E8972",
            INIT_52=>X"7FC78013805E80AA80F68143819081DD822A827882C68315836383B284028451",
            INIT_53=>X"7B3D7B837BCA7C107C587C9F7CE77D2F7D787DC17E0A7E537E9D7EE77F327F7C",
            INIT_54=>X"77047745778677C8780A784D788F78D27916795A799E79E27A277A6C7AB17AF7",
            INIT_55=>X"7320735B739773D47411744E748B74C975077545758475C376037643768376C3",
            INIT_56=>X"6F926FC86FFF7036706D70A570DD7115714E718771C071FA7234726E72A972E4",
            INIT_57=>X"6C5E6C8E6CBF6CF16D226D546D876DBA6DED6E206E546E886EBD6EF16F276F5C",
            INIT_58=>X"698569AF69DB6A066A326A5F6A8B6AB86AE66B136B426B706B9F6BCE6BFE6C2E",
            INIT_59=>X"6708672D67526778679E67C567EC6813683B6863688B68B468DD69066930695A",
            INIT_5A=>X"64EA6509652865486569658965AA65CB65ED660F663266546678669B66BF66E3",
            INIT_5B=>X"632B6344635E6378639263AD63C863E363FF641B643764546471648F64AD64CB",
            INIT_5C=>X"61CE61E161F46208621C62306245625B62706286629D62B462CB62E262FA6313",
            INIT_5D=>X"60D160DE60EC60F9610761166125613461436153616461746185619761A961BB",
            INIT_5E=>X"6037603E6045604D6055605D6066606F60786082608C609760A260AD60B960C5",
            INIT_5F=>X"6000600060016003600460076009600C600F60136017601B60206025602B6031",
            INIT_60=>X"602B60256020601B60176013600F600C60096007600460036001600060006000",
            INIT_61=>X"60B960AD60A26097608C60826078606F6066605D6055604D6045603E60376031",
            INIT_62=>X"61A9619761856174616461536143613461256116610760F960EC60DE60D160C5",
            INIT_63=>X"62FA62E262CB62B4629D62866270625B62456230621C620861F461E161CE61BB",
            INIT_64=>X"64AD648F647164546437641B63FF63E363C863AD63926378635E6344632B6313",
            INIT_65=>X"66BF669B667866546632660F65ED65CB65AA6589656965486528650964EA64CB",
            INIT_66=>X"6930690668DD68B4688B6863683B681367EC67C5679E67786752672D670866E3",
            INIT_67=>X"6BFE6BCE6B9F6B706B426B136AE66AB86A8B6A5F6A326A0669DB69AF6985695A",
            INIT_68=>X"6F276EF16EBD6E886E546E206DED6DBA6D876D546D226CF16CBF6C8E6C5E6C2E",
            INIT_69=>X"72A9726E723471FA71C07187714E711570DD70A5706D70366FFF6FC86F926F5C",
            INIT_6A=>X"76837643760375C375847545750774C9748B744E741173D47397735B732072E4",
            INIT_6B=>X"7AB17A6C7A2779E2799E795A791678D2788F784D780A77C877867745770476C3",
            INIT_6C=>X"7F327EE77E9D7E537E0A7DC17D787D2F7CE77C9F7C587C107BCA7B837B3D7AF7",
            INIT_6D=>X"840283B28363831582C68278822A81DD8190814380F680AA805E80137FC77F7C",
            INIT_6E=>X"891E88CA8876882387D0877D872B86D88686863585E38592854284F184A18451",
            INIT_6F=>X"8E848E2B8DD38D7B8D248CCC8C758C1E8BC88B728B1C8AC68A718A1C89C78972",
            INIT_70=>X"943093D39376931A92BE9263920791AC915190F7909C90428FE88F8F8F368EDD",
            INIT_71=>X"9A1E99BD995D98FC989C983C97DD977E971F96C09661960395A5954794EA948D",
            INIT_72=>X"A04B9FE69F829F1E9EBA9E569DF39D909D2D9CCA9C689C059BA39B429AE09A7F",
            INIT_73=>X"A6B3A64BA5E3A57BA514A4ACA445A3DEA378A311A2ABA245A1E0A17AA115A0B0",
            INIT_74=>X"AD52ACE7AC7BAC10ABA6AB3BAAD0AA66A9FCA992A929A8BFA856A7EDA784A71B",
            INIT_75=>X"B424B3B6B348B2D9B26BB1FEB190B122B0B5B048AFDBAF6FAF02AE96AE2AADBE",
            INIT_76=>X"BB25BAB4BA43B9D2B961B8F0B880B80FB79FB72FB6C0B650B5E0B571B502B493",
            INIT_77=>X"C251C1DDC169C0F6C082C00FBF9CBF29BEB6BE43BDD1BD5FBCECBC7ABC09BB97",
            INIT_78=>X"C9A2C92CC8B6C840C7CBC755C6E0C66AC5F5C580C50BC496C422C3ADC339C2C5",
            INIT_79=>X"D115D09DD025CFADCF36CEBECE47CDCFCD58CCE1CC6ACBF3CB7CCB05CA8FCA19",
            INIT_7A=>X"D8A5D82BD7B2D738D6BFD645D5CCD553D4DAD461D3E8D36FD2F7D27ED206D18D",
            INIT_7B=>X"E04DDFD2DF57DEDCDE61DDE7DD6CDCF1DC77DBFCDB82DB07DA8DDA13D999D91F",
            INIT_7C=>X"E809E78DE711E695E619E59DE521E4A5E429E3ADE332E2B6E23BE1BFE144E0C9",
            INIT_7D=>X"EFD4EF57EEDAEE5DEDE0ED63ECE6EC6AEBEDEB70EAF4EA77E9FBE97EE902E885",
            INIT_7E=>X"F7A8F72BF6ADF630F5B2F535F4B8F43AF3BDF340F2C2F245F1C8F14BF0CEF051",
            INIT_7F=>X"FF82FF04FE87FE09FD8BFD0EFC90FC12FB95FB17FA99FA1CF99EF921F8A3F826",
            SIM_DEVICE=>"7SERIES"
        ) port map (
            -- Cascade Signals:
            CASCADEOUTA=>open,
            CASCADEOUTB=>open,
            -- ECC Signals:
            DBITERR=>open,
            ECCPARITY=>open,
            RDADDRECC=>open,
            SBITERR=>open,
            -- Port A Data Out:
            DOADO=>bram_data_r(31 downto 0),
            DOPADOP=>bram_data_r(35 downto 32),
            -- Port B Data Out:
            DOBDO=>bram_data_l(31 downto 0),
            DOPBDOP=>bram_data_l(35 downto 32),
            -- Cascade Signals:
            CASCADEINA=>'0',
            CASCADEINB=>'0',
            -- ECC Signals:
            INJECTDBITERR=>'0',
            INJECTSBITERR=>'0',
            -- Port A Address/Control Signals:
            ADDRARDADDR=>bram_addr_r,
            CLKARDCLK=>clk,
            ENARDEN=>'1',
            REGCEAREGCE=>'1',
            RSTRAMARSTRAM=>'0',
            RSTREGARSTREG=>'0',
            WEA=>(others=>'0'),
            -- Port A Data In:
            DIADI=>(others=>'0'),
            DIPADIP=>(others=>'0'),
            -- Port B Address/Control Signals:
            ADDRBWRADDR=>bram_addr_l,
            CLKBWRCLK=>clk,
            ENBWREN=>'1',
            REGCEB=>'1',
            RSTRAMB=>'0',
            RSTREGB=>'0',
            WEBWE=>(others=>'0'),
            -- Port B Data: 32-bit (each) input: Port B data
            DIBDI=>(others=>'0'),
            DIPBDIP=>(others=>'0')
        );
end arch;